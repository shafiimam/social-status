<div class="virtual-try-on-section">
  <div class="vto-container">
    <div class="vto-header">
      <h1 class="h1 text-center heading">{{ section.settings.heading }}</h1>
      <p class="text-subdued text-center">{{ section.settings.subheading }}</p>
    </div>
    <!-- Left Column: Vertical Slider -->
    <div class="vto-content-container">
      <div class="vto-slider">
        <div class="vto-slider-inner">
          {% for block in section.blocks %}
            {% if block.settings.product_image %}
              <div class="vto-slide" {{ block.shopify_attributes }}>
                <img
                  id="product-image-{{ block.id }}"
                  src="{{ block.settings.product_image | image_url: width: 600 }}"
                  alt="Slide Image"
                  loading="lazy"
                  width="600"
                  height="600" 
                >
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Right Column: Static Image -->
      <div class="vto-qr-container">
        {% for block in section.blocks %}
          {% if block.settings.product_qr_image %}
            <img
              class="{% if forloop.first %}active-slide{% endif %}"
              id="product-qr-image-{{ block.id }}"
              src="{{ block.settings.product_qr_image | image_url: width: 600 }}"
              alt="Product QR Image"
              loading="lazy"
              width="600"
              height="600"
            >
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<script>
  class VirtualTryOnSlider {
    constructor() {
      this.sliderInner = document.querySelector('.vto-slider-inner');
      this.qrContainer = document.querySelector('.vto-qr-container');
      this.slides = document.querySelectorAll('.vto-slide');
      this.qrImages = document.querySelectorAll('.vto-qr-container img');
      this.scrollTimeout = null;

      this.init();
    }

    init() {
      this.showFirstQRImage();
      this.bindEvents();
      this.updateQRImage();
    }

    showFirstQRImage() {
      if (this.qrImages.length > 0) {
        this.qrImages[0].classList.add('active-slide');
      }
    }

    bindEvents() {
      this.sliderInner.addEventListener('scroll', () => this.handleScroll());
    }

    handleScroll() {
      // Clear existing timeout
      if (this.scrollTimeout) {
        clearTimeout(this.scrollTimeout);
      }
      
      // Set new timeout to wait for scroll to end
      this.scrollTimeout = setTimeout(() => {
        this.updateQRImage();
      }, 200); // Wait 150ms after scroll stops
    }

    updateQRImage() {
      const activeSlideIndex = this.findActiveSlideIndex();
      this.updateQRImageDisplay(activeSlideIndex);
    }

    findActiveSlideIndex() {
      const sliderRect = this.sliderInner.getBoundingClientRect();
      const sliderCenter = sliderRect.top + sliderRect.height * 0.5;

      let activeSlideIndex = 0;
      let minDistance = Infinity;

      this.slides.forEach((slide, index) => {
        const slideRect = slide.getBoundingClientRect();
        const slideCenter = slideRect.top + slideRect.height * 0.5;
        const distance = Math.abs(sliderCenter - slideCenter);

        if (distance < minDistance) {
          minDistance = distance;
          activeSlideIndex = index;
        }
      });

      return activeSlideIndex;
    }

    updateQRImageDisplay(activeSlideIndex) {
      this.qrImages.forEach((img) => {
        img.classList.remove('active-slide');
      });

      if (this.qrImages[activeSlideIndex]) {
        this.qrImages[activeSlideIndex].classList.add('active-slide');
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    new VirtualTryOnSlider();
  });
</script>

{{ 'section-virtual-try-on.css' | asset_url | stylesheet_tag }}
{% schema %}
{
  "name": "Virtual Try-On",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Step In The Culture"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Step In The Culture"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Virtual Try-On Product",
      "settings": [
        {
          "type": "image_picker",
          "id": "product_image",
          "label": "Product Image"
        },
        {
          "type": "image_picker",
          "id": "product_qr_image",
          "label": "Product QR Image"
        }
      ]
    }
  ],
  "max_blocks": 10,
  "presets": [
    {
      "name": "Virtual Try-On"
    }
  ]
}
{% endschema %}
